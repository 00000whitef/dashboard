<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Dashboard V3.2 | Task History</title>
    <style>
        /* --- CSS æ¨£å¼å€ (éŸ“ç³» Y2K) --- */
        :root {
            --bg-color: #fcfcfc;
            --primary-pink: #ffd1dc;
            --hot-pink: #ff69b4;
            --accent-black: #222222;
            --border-color: #222222;
            --gray-text: #666666;
            --font-main: 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--accent-black);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- é ‚éƒ¨å°èˆªæ¬„ --- */
        nav.top-nav {
            background: var(--accent-black);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            z-index: 100;
        }

        .nav-title {
            color: white;
            font-weight: bold;
            font-style: italic;
            font-size: 1.2rem;
        }

        .nav-buttons { display: flex; gap: 10px; }
        .nav-btn {
            background: transparent;
            border: 2px solid white;
            color: white;
            padding: 8px 20px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            transition: 0.2s;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.2); }
        .nav-btn.active {
            background: var(--primary-pink);
            color: var(--accent-black);
            border-color: var(--primary-pink);
            box-shadow: 4px 4px 0 white;
            transform: translate(-2px, -2px);
        }

        /* --- ä¸»è¦–åœ–å®¹å™¨ --- */
        main {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        .view-section {
            display: none;
            height: 100%;
            animation: fadeIn 0.3s ease;
        }
        .view-section.active-view {
            display: flex;
            flex-direction: column;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- é€šç”¨å…ƒä»¶ --- */
        h2 {
            border-bottom: 3px solid var(--accent-black);
            padding-bottom: 10px;
            margin-top: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .btn-action {
            background: var(--accent-black);
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-action:hover { opacity: 0.8; }
        .btn-danger { background: #ff4d4d; color: white; border: none; padding: 5px 10px; cursor: pointer; }

        input, select { padding: 10px; border: 2px solid var(--border-color); margin-right: 5px; }

        /* --- è¦–åœ– 1: Wishlist --- */
        .wishlist-container { max-width: 1000px; margin: 0 auto; width: 100%; }
        .wish-list { list-style: none; padding: 0; }
        .wish-item {
            display: flex; justify-content: space-between; align-items: center;
            border: 2px solid var(--border-color); padding: 15px; margin-bottom: 10px;
            background: white; box-shadow: 4px 4px 0 #eee; transition: 0.2s; cursor: pointer;
        }
        .wish-item:hover { box-shadow: 6px 6px 0 var(--primary-pink); transform: translateX(-2px); }

        /* --- è¦–åœ– 2: Planner --- */
        .planner-layout {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
            height: 100%;
            min-height: 600px;
        }

        .todo-pool-panel {
            background: white; border: 2px solid var(--border-color); padding: 15px;
            display: flex; flex-direction: column;
        }
        .pool-list {
            flex: 1; background: #f4f4f4; border: 1px dashed #999;
            padding: 10px; overflow-y: auto; margin-top: 10px;
        }
        .todo-card {
            background: white; border: 1px solid var(--border-color); padding: 8px;
            margin-bottom: 8px; cursor: grab; box-shadow: 2px 2px 0 rgba(0,0,0,0.1); font-size: 0.9rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        .todo-card:active { cursor: grabbing; }

        .calendar-panel {
            background: white; border: 2px solid var(--border-color);
            display: flex; flex-direction: column; position: relative;
        }

        .cal-header-bar {
            background: var(--primary-pink); padding: 10px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid var(--border-color);
        }
        
        .cal-controls-right { display: flex; gap: 5px; }
        .btn-mode {
            background: white; border: 2px solid black; padding: 2px 8px; 
            font-size: 0.8rem; cursor: pointer; font-weight: bold;
        }
        .btn-mode.active-mode { background: black; color: white; }

        /* æœˆæ›†æ¨¡å¼ */
        .mode-month { display: flex; flex-direction: column; flex: 1; height: 100%; }
        .cal-week-header {
            display: grid; grid-template-columns: repeat(7, 1fr);
            border-bottom: 2px solid var(--border-color); background: #fff;
        }
        .cal-day-name { padding: 10px; text-align: center; font-weight: bold; border-right: 1px solid #eee; }
        .cal-grid-body {
            display: grid; grid-template-columns: repeat(7, 1fr);
            flex: 1; overflow-y: auto;
        }
        .day-cell {
            border-right: 1px solid #eee; border-bottom: 1px solid #eee;
            min-height: 100px; padding: 5px; background: white;
            position: relative; transition: background 0.2s; cursor: pointer;
        }
        .day-cell:hover { background: #fffbfd; }
        .day-cell.drag-over { background: var(--primary-pink); }
        .day-cell.today { background: #fff0f5; }
        .date-number { font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; display: block; }
        .cal-task-item {
            background: var(--accent-black); color: white; font-size: 0.75rem;
            padding: 3px 6px; margin-bottom: 2px; border-radius: 4px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        /* æ—¥æ›†æ¨¡å¼ */
        .mode-day {
            display: none; padding: 30px; flex: 1; overflow-y: auto;
            background-image: radial-gradient(#ddd 1px, transparent 1px); background-size: 20px 20px;
        }
        .day-view-header {
            font-size: 1.5rem; font-weight: bold; margin-bottom: 20px;
            border-bottom: 4px solid var(--accent-black); padding-bottom: 10px;
        }
        .day-task-list { list-style: none; padding: 0; max-width: 800px; }
        .day-task-row {
            display: flex; align-items: center; background: white;
            border: 2px solid black; padding: 15px; margin-bottom: 10px;
            box-shadow: 4px 4px 0 #ccc;
        }
        .day-task-row span { flex: 1; font-size: 1.1rem; }

        /* --- è¦–åœ– 3: Finished (æ–°åŠŸèƒ½) --- */
        .finished-container {
            max-width: 1000px; margin: 0 auto; width: 100%;
        }
        .finished-table {
            width: 100%; border-collapse: collapse; background: white;
            border: 2px solid var(--border-color);
        }
        .finished-table th, .finished-table td {
            border: 1px solid #ddd; padding: 12px; text-align: left;
        }
        .finished-table th { background: #eee; border-bottom: 2px solid black; }
        .finished-table tr:hover { background: #fafafa; }
        .status-badge {
            background: #e8f5e9; color: #2e7d32; padding: 4px 8px; 
            border-radius: 4px; font-size: 0.8rem; font-weight: bold; border: 1px solid #c8e6c9;
        }

        /* --- Modal & Globals --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal {
            background: white; width: 400px; padding: 25px;
            border: 2px solid black; box-shadow: 10px 10px 0 var(--hot-pink);
        }
        .global-export { position: fixed; bottom: 20px; right: 20px; z-index: 900; }
    </style>
</head>
<body>

<nav class="top-nav">
    <div class="nav-title">â˜… K-DASHBOARD</div>
    <div class="nav-buttons">
        <button class="nav-btn active" id="btn-wish" onclick="switchMainView('wishlist')">è³¼ç‰©æ¸…å–® Wishlist</button>
        <button class="nav-btn" id="btn-plan" onclick="switchMainView('planner')">è¡Œäº‹æ›† Planner</button>
        <button class="nav-btn" id="btn-done" onclick="switchMainView('finished')">å·²å®Œæˆ Finished</button>
    </div>
</nav>

<main>
    <div id="view-wishlist" class="view-section active-view">
        <div class="wishlist-container">
            <h2>
                <span>WISH LIST // è³¼ç‰©æ¸…å–®</span>
                <span style="background:var(--primary-pink); padding:5px 10px; font-size:1rem; border:1px solid black;">
                    Total: $<span id="totalDisplay">0</span>
                </span>
            </h2>
            <div style="background:#fff; padding:20px; border:2px solid black; margin-bottom:20px;">
                <select id="wCat"><option>ç¾å¦</option><option>æœé£¾</option><option>æ•¸ç¢¼</option><option>å®¶å±…</option></select>
                <input type="text" id="wName" placeholder="å•†å“åç¨±" style="width:200px;">
                <input type="number" id="wPrice" placeholder="åƒ¹æ ¼" style="width:100px;">
                <button class="btn-action" onclick="addWishItem()">åŠ å…¥æ¸…å–® +</button>
            </div>
            <ul class="wish-list" id="wishContainer"></ul>
        </div>
    </div>

    <div id="view-planner" class="view-section">
        <div class="planner-layout">
            
            <div class="todo-pool-panel">
                <h3 style="margin-top:0;">å¾…è¾¦äº‹é … Pool</h3>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <input type="text" id="todoInput" placeholder="è¼¸å…¥äº‹é …..." style="width:100%">
                    <button class="btn-action" style="padding:5px 10px;" onclick="addTodo()">+</button>
                </div>
                <small style="color:#666; display:block; margin-bottom:5px;">æ‹–æ›³å¡ç‰‡è‡³å³å´æ—¥æ›† (æœˆæª¢è¦–)</small>
                <div class="pool-list" id="todoPool" ondragover="allowDrop(event)" ondrop="dropToPool(event)"></div>
            </div>

            <div class="calendar-panel">
                <div class="cal-header-bar">
                    <div id="calNavBtns">
                        <button onclick="changeMonth(-1)" class="btn-action" style="padding:2px 8px;">â—€</button>
                        <span id="calTitle" style="margin:0 10px; font-size:1.1rem;">2026 å¹´ 1 æœˆ</span>
                        <button onclick="changeMonth(1)" class="btn-action" style="padding:2px 8px;">â–¶</button>
                    </div>
                    <div class="cal-controls-right">
                        <button class="btn-mode active-mode" id="btnModeMonth" onclick="setCalMode('month')">æœˆæ›†</button>
                        <button class="btn-mode" id="btnModeDay" onclick="setCalMode('day')">æ—¥æ›†</button>
                    </div>
                </div>

                <div id="monthSection" class="mode-month">
                    <div class="cal-week-header">
                        <div class="cal-day-name">SUN</div><div class="cal-day-name">MON</div>
                        <div class="cal-day-name">TUE</div><div class="cal-day-name">WED</div>
                        <div class="cal-day-name">THU</div><div class="cal-day-name">FRI</div>
                        <div class="cal-day-name">SAT</div>
                    </div>
                    <div class="cal-grid-body" id="calendarGrid"></div>
                </div>

                <div id="daySection" class="mode-day">
                    <div class="day-view-header" id="dayViewTitle">Today</div>
                    <ul class="day-task-list" id="dayTaskList"></ul>
                    <p style="color:#666; margin-top:20px;">æç¤ºï¼šå¦‚éœ€å®‰æ’æ–°æ—¥æœŸï¼Œè«‹åˆ‡æ›å›ã€Œæœˆæ›†ã€æ¨¡å¼é€²è¡Œæ‹–æ›³ã€‚</p>
                    <button class="btn-action" onclick="setCalMode('month')">è¿”å›æœˆæ›†</button>
                </div>
            </div>
        </div>
    </div>

    <div id="view-finished" class="view-section">
        <div class="finished-container">
            <h2>
                <span>FINISHED TASKS // å®Œæˆç´€éŒ„</span>
                <button class="btn-action" style="background:#fff; color:black; border:1px solid black;" onclick="clearFinishedHistory()">æ¸…ç©ºæ­·å²</button>
            </h2>
            <table class="finished-table">
                <thead>
                    <tr>
                        <th style="width: 40%">ä»»å‹™å…§å®¹ (Task)</th>
                        <th style="width: 20%">åŸå®šæ—¥æœŸ (Scheduled)</th>
                        <th style="width: 20%">å®Œæˆæ—¥æœŸ (Completed)</th>
                        <th style="width: 10%">ç‹€æ…‹</th>
                        <th style="width: 10%">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="finishedListBody">
                    </tbody>
            </table>
            <p id="emptyMsg" style="text-align:center; color:#999; margin-top:20px;">æš«ç„¡å®Œæˆç´€éŒ„</p>
        </div>
    </div>
</main>

<div class="modal-overlay" id="detailModal">
    <div class="modal">
        <h3 id="modalTitle">Detail</h3>
        <p>å‚™è¨»:</p>
        <textarea id="modalNote" style="width:100%; height:80px; margin-bottom:10px; border:1px solid #ccc;"></textarea>
        <div style="text-align:right; gap:10px;">
            <button class="btn-action" style="background:red;" onclick="deleteItem()">åˆªé™¤</button>
            <button class="btn-action" onclick="saveModal()">ä¿å­˜</button>
            <button class="btn-action" style="background:#ccc;" onclick="closeModal()">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div class="global-export">
    <button class="btn-action" onclick="exportData()">ğŸ’¾ å‚™ä»½æ•¸æ“š</button>
    <input type="file" id="fileIn" hidden onchange="importData(this)">
    <button class="btn-action" style="background:#fff; color:#000; border:2px solid #000;" onclick="document.getElementById('fileIn').click()">ğŸ“‚ è®€å–å‚™ä»½</button>
</div>

<script>
    // --- Data Structure ---
    // æ–°å¢ finished é™£åˆ—
    let db = { 
        wishlist: [], 
        todos: [], // å¾…è¾¦ {id, text, date}
        finished: [] // å·²å®Œæˆ {id, text, scheduledDate, completedDate}
    };
    
    let currentDate = new Date();
    let selectedDay = new Date(); 
    let currentItemId = null;

    // --- Init ---
    window.onload = function() {
        const saved = localStorage.getItem('k_dashboard_v3');
        if(saved) {
            const parsed = JSON.parse(saved);
            // å…¼å®¹èˆŠç‰ˆæœ¬æ•¸æ“š (å¦‚æœæ²’æœ‰ finished å­—æ®µå‰‡è£œä¸Š)
            if(!parsed.finished) parsed.finished = [];
            db = parsed;
        }
        renderWishlist();
        renderTodoPool();
        renderCalendar();
    };

    function saveData() { localStorage.setItem('k_dashboard_v3', JSON.stringify(db)); }

    // --- Navigation ---
    function switchMainView(view) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById('view-' + view).classList.add('active-view');
        
        if(view === 'wishlist') document.getElementById('btn-wish').classList.add('active');
        if(view === 'planner') {
            document.getElementById('btn-plan').classList.add('active');
            renderCalendar();
        }
        if(view === 'finished') {
            document.getElementById('btn-done').classList.add('active');
            renderFinished(); // æ¸²æŸ“å®Œæˆåˆ—è¡¨
        }
    }

    // --- Core Feature: Finish Task (æ–°åŠŸèƒ½æ ¸å¿ƒ) ---
    function finishTask(id) {
        // 1. åœ¨å¾…è¾¦ä¸­æ‰¾åˆ°å®ƒ
        const taskIndex = db.todos.findIndex(t => t.id === id);
        if(taskIndex === -1) return;

        const task = db.todos[taskIndex];
        
        // 2. æ§‹å»ºå®Œæˆç´€éŒ„
        const today = new Date().toISOString().split('T')[0];
        const record = {
            id: task.id,
            text: task.text,
            scheduledDate: task.date ? task.date : '-', // å¦‚æœåœ¨Poolè£¡å®Œæˆå°±æ˜¯ '-'
            completedDate: today
        };

        // 3. ç§»å‹•æ•¸æ“š
        db.finished.push(record); // åŠ å…¥å®Œæˆå€
        db.todos.splice(taskIndex, 1); // å¾å¾…è¾¦å€ç§»é™¤

        // 4. ä¿å­˜ä¸¦åˆ·æ–°
        saveData();
        renderTodoPool();
        renderCalendar();
        renderDayView();
        
        // å¦‚æœåœ¨æ—¥æ›†æ¨¡å¼ä¸‹ï¼Œä¸å¼·åˆ¶è·³è½‰ï¼Œè®“ç”¨æˆ¶åœç•™åœ¨ç•¶å‰è¦–åœ–
    }

    // åˆªé™¤å·²å®Œæˆçš„ç´€éŒ„ (æ°¸ä¹…åˆªé™¤)
    function deleteFinished(id) {
        if(confirm("ç¢ºå®šæ°¸ä¹…åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ")) {
            db.finished = db.finished.filter(t => t.id !== id);
            saveData();
            renderFinished();
        }
    }
    
    function clearFinishedHistory() {
        if(confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰å®Œæˆç´€éŒ„ï¼Ÿç„¡æ³•å¾©åŸï¼")) {
            db.finished = [];
            saveData();
            renderFinished();
        }
    }

    // --- Render Finished View ---
    function renderFinished() {
        const tbody = document.getElementById('finishedListBody');
        const emptyMsg = document.getElementById('emptyMsg');
        tbody.innerHTML = '';

        if(db.finished.length === 0) {
            emptyMsg.style.display = 'block';
            return;
        } else {
            emptyMsg.style.display = 'none';
        }

        // æŒ‰å®Œæˆæ—¥æœŸå€’åºæ’åˆ— (æœ€æ–°çš„åœ¨ä¸Šé¢)
        const sorted = [...db.finished].sort((a,b) => b.completedDate.localeCompare(a.completedDate));

        sorted.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.text}</td>
                <td style="color:#666;">${item.scheduledDate}</td>
                <td><b>${item.completedDate}</b></td>
                <td><span class="status-badge">DONE</span></td>
                <td><button class="btn-danger" onclick="deleteFinished('${item.id}')">Ã—</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- Other Render & Logics (ä¿ç•™åŸæœ‰åŠŸèƒ½) ---
    
    // Calendar Modes
    function setCalMode(mode) {
        document.getElementById('monthSection').style.display = mode === 'month' ? 'flex' : 'none';
        document.getElementById('daySection').style.display = mode === 'day' ? 'block' : 'none';
        document.getElementById('btnModeMonth').className = mode === 'month' ? 'btn-mode active-mode' : 'btn-mode';
        document.getElementById('btnModeDay').className = mode === 'day' ? 'btn-mode active-mode' : 'btn-mode';
        const navBtns = document.getElementById('calNavBtns');
        if(mode === 'day') { renderDayView(); navBtns.style.visibility = 'hidden'; } 
        else { renderCalendar(); navBtns.style.visibility = 'visible'; }
    }
    function goToDay(dateStr) { selectedDay = new Date(dateStr); setCalMode('day'); }

    // Wishlist
    function addWishItem() {
        const name = document.getElementById('wName').value;
        const price = document.getElementById('wPrice').value;
        const cat = document.getElementById('wCat').value;
        if(!name) return;
        db.wishlist.push({ id: Date.now(), cat, name, price: parseFloat(price)||0, note: '' });
        document.getElementById('wName').value = ''; saveData(); renderWishlist();
    }
    function renderWishlist() {
        const list = document.getElementById('wishContainer');
        const totalDisp = document.getElementById('totalDisplay');
        list.innerHTML = ''; let total = 0;
        db.wishlist.forEach(item => {
            total += item.price;
            const li = document.createElement('li');
            li.className = 'wish-item';
            li.innerHTML = `<span><b style="background:#eee;">${item.cat}</b> ${item.name}</span><b>$${item.price}</b>`;
            li.onclick = () => openModal(item.id);
            list.appendChild(li);
        });
        totalDisp.innerText = total.toLocaleString();
    }
    // Wishlist Modal
    function openModal(id) {
        currentItemId = id; const item = db.wishlist.find(i => i.id === id);
        if(item) {
            document.getElementById('modalTitle').innerText = item.name;
            document.getElementById('modalNote').value = item.note || '';
            document.getElementById('detailModal').style.display = 'flex';
        }
    }
    function closeModal() { document.getElementById('detailModal').style.display = 'none'; }
    function saveModal() {
        const item = db.wishlist.find(i => i.id === currentItemId);
        if(item) { item.note = document.getElementById('modalNote').value; saveData(); renderWishlist(); } closeModal();
    }
    function deleteItem() {
        if(confirm("åˆªé™¤?")) { db.wishlist = db.wishlist.filter(i => i.id !== currentItemId); saveData(); renderWishlist(); closeModal(); }
    }

    // Todos
    function addTodo() {
        const input = document.getElementById('todoInput');
        if(!input.value) return;
        db.todos.push({ id: 'task_'+Date.now(), text: input.value, date: null });
        input.value = ''; saveData(); renderTodoPool();
    }
    function renderTodoPool() {
        const pool = document.getElementById('todoPool'); pool.innerHTML = '';
        db.todos.filter(t => !t.date).forEach(t => {
            const div = document.createElement('div');
            div.className = 'todo-card'; div.draggable = true;
            div.innerHTML = `<span>${t.text}</span> <span style="color:green;cursor:pointer;font-weight:bold;" onclick="finishTask('${t.id}')">âœ“</span>`;
            div.ondragstart = (e) => e.dataTransfer.setData("text", t.id);
            pool.appendChild(div);
        });
    }

    // Calendar
    function changeMonth(delta) { currentDate.setMonth(currentDate.getMonth() + delta); renderCalendar(); }
    function renderCalendar() {
        const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
        const year = currentDate.getFullYear(); const month = currentDate.getMonth();
        document.getElementById('calTitle').innerText = `${year} å¹´ ${month + 1} æœˆ`;
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for(let i=0; i<firstDay; i++) {
            const empty = document.createElement('div'); empty.className = 'day-cell'; empty.style.background = '#fcfcfc'; grid.appendChild(empty);
        }
        for(let d=1; d<=daysInMonth; d++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const cell = document.createElement('div'); cell.className = 'day-cell';
            if(dateStr === new Date().toISOString().split('T')[0]) cell.classList.add('today');

            cell.ondragover = (e) => { e.preventDefault(); cell.classList.add('drag-over'); };
            cell.ondragleave = (e) => cell.classList.remove('drag-over');
            cell.ondrop = (e) => {
                e.preventDefault(); cell.classList.remove('drag-over');
                const tid = e.dataTransfer.getData("text");
                const t = db.todos.find(x => x.id === tid);
                if(t) { t.date = dateStr; saveData(); renderTodoPool(); renderCalendar(); }
            };
            cell.onclick = (e) => { if(e.target.classList.contains('cal-task-item')) return; goToDay(dateStr); };
            
            cell.innerHTML = `<span class="date-number">${d}</span>`;
            db.todos.filter(t => t.date === dateStr).forEach(t => {
                const div = document.createElement('div'); div.className = 'cal-task-item'; div.innerText = t.text; div.draggable = true;
                div.ondragstart = (e) => e.dataTransfer.setData("text", t.id);
                // é»æ“Šæ—¥æ›†ä¸Šçš„å°ä»»å‹™ä¹Ÿå¯ä»¥ç›´æ¥å®Œæˆ
                div.onclick = (e) => {
                    e.stopPropagation();
                    if(confirm(`å®Œæˆä»»å‹™: ${t.text}?`)) finishTask(t.id);
                };
                cell.appendChild(div);
            });
            grid.appendChild(cell);
        }
    }
    function dropToPool(e) {
        e.preventDefault(); const tid = e.dataTransfer.getData("text");
        const t = db.todos.find(x => x.id === tid);
        if(t && t.date) { t.date = null; saveData(); renderTodoPool(); renderCalendar(); }
    }

    // Day View
    function renderDayView() {
        const list = document.getElementById('dayTaskList'); list.innerHTML = '';
        const dateStr = `${selectedDay.getFullYear()}-${String(selectedDay.getMonth()+1).padStart(2,'0')}-${String(selectedDay.getDate()).padStart(2,'0')}`;
        document.getElementById('dayViewTitle').innerText = `${dateStr} // å¾…è¾¦æ¸…å–®`;
        
        const tasks = db.todos.filter(t => t.date === dateStr);
        if(tasks.length === 0) list.innerHTML = '<li style="color:#999; text-align:center;">ç„¡</li>';
        else {
            tasks.forEach(t => {
                const li = document.createElement('li'); li.className = 'day-task-row';
                li.innerHTML = `<span>${t.text}</span> <button class="btn-action" onclick="finishTask('${t.id}')">å®Œæˆ âœ“</button>`;
                list.appendChild(li);
            });
        }
    }

    // Export/Import
    function exportData() {
        const blob = new Blob([JSON.stringify(db, null, 2)], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = "k_dashboard_v3_2.json"; a.click();
    }
    function importData(inp) {
        if(!inp.files[0]) return;
        const r = new FileReader();
        r.onload = (e) => {
            try { db = JSON.parse(e.target.result); saveData(); location.reload(); }
            catch(err){ alert("Error"); }
        };
        r.readAsText(inp.files[0]);
    }
</script>
</body>
</html>